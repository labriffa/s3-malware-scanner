'use strict';

require('dotenv').config();
const AWS = require('aws-sdk');

// Set the AWS region 
AWS.config.update({ region: process.env.AWS_CLOUDFORMATION_REGION });

const virusTotalAPI = new (require('./services/scanners/VirusTotalAPI'))({ apiKey: process.env.TOTAL_VIRUS_API_KEY });
const s3StorageService = new (require('./services/storage/S3StorageService'))(new AWS.S3());
const sqsMessageQueue = new (require('./services/queues/SQSMessageQueue'))(new AWS.SQS());
const s3MalwareApp = new (require('./services/apps/S3MalwareApp'))(sqsMessageQueue, virusTotalAPI);

exports.handler = (event, context, callback) => {
	// Loop through the contents of the s3 event records
	for (let eventRecord of event.Records) {
		s3StorageService.getFile(
			{
				Bucket: process.env.AWS_S3_BUCKET_NAME,
				Key: eventRecord.s3.object.key
			},
			(err, file) => {
				if ("Body" in file) {
					file ? s3MalwareApp.scan(process.env.AWS_S3_BUCKET_NAME, eventRecord.s3.object.key, file.Body.toString('base64'), callback) : console.error(err);
				} else {
					console.error('Could not find body for given file ', file);
				}
			}
		);
	}
};