'use strict';

require('dotenv').config();
const AWS = require('aws-sdk');

// Set the AWS region 
AWS.config.update({ region: process.env.AWS_CLOUDFORMATION_REGION });

const virusTotalScanner = new (require('./services/scanners/VirusTotalAPI'))({ apiKey: process.env.TOTAL_VIRUS_API_KEY });
const sqsMessageQueue = new (require('./services/queues/SQSMessageQueue'))(new AWS.SQS());
const s3MalwareApp = new (require('./services/apps/S3MalwareApp'))(sqsMessageQueue, virusTotalScanner);

exports.handler = (event, context, callback) => {
	// Loop through the contents of the sqs event records
	for (let eventRecord of event.Records) {
		const scanId = eventRecord.messageAttributes.ScanId.stringValue;
		const s3bucketName = eventRecord.messageAttributes.S3BucketName.stringValue;
		const s3key = eventRecord.messageAttributes.S3Key.stringValue;
		s3MalwareApp.report(scanId, s3bucketName, s3key, callback);
	}
};