//exports.handler = (event, context, callback) => {
require('dotenv').config();
const AWS = require('aws-sdk');

// Set the AWS region 
AWS.config.update({ region: process.env.AWS_REGION });

const VirusTotal = new (require('./services/VirusTotal.js'))({
	apiKey: process.env.TOTAL_VIRUS_API_KEY
});

VirusTotal.fileScanFromUri('README.md').then((data) => {
	// Add to SQS scan queue
	const sqs = new AWS.SQS();

	var params = {
		DelaySeconds: process.env.AWS_SCAN_SQS_DELAY_SECONDS,
		MessageAttributes: {
			"ScanId": {
				DataType: "String",
				StringValue: data.scan_id
			},
			"Permalink": {
				DataType: "String",
				StringValue: data.permalink
			}
		},
		MessageBody: data.verbose_msg,
		QueueUrl: process.env.AWS_SCAN_SQS_URL
	};

	sqs.sendMessage(params, function (err, data) {
		if (err) {
			callback(null, 'success');
		} else {
			callback(err);
		}
	});

}).catch((err) => {
	console.err(err);
});

//};

