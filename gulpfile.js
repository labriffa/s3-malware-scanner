'use strict';

const gulp = require('gulp');
const exec = require('child_process').exec;

const cmd = {
	'codebuild_build': '~/Desktop/s3-malware-scanner/aws-codebuild-docker-images/ubuntu/standard/3.0/codebuild_build.sh',
	'image': 'amazon/aws-codebuild-local:latest',
	'source': '/Users/smb/Desktop/s3-malware-scanner/',
	'artifact': '/Users/smb/Desktop/s3-malware-scanner/builds/lambdas/',
	'env': '/Users/smb/Desktop/s3-malware-scanner/.env',
};

/**
 * Uses a local CodeBuild docker image to create a lambda and all its dependencies bundled into an
 * artifacts zip as per defined in the buildspec-scan.yml file
 */
function buildLambda(lambdaName, cb) {
	exec(`${cmd.codebuild_build} -b ./builds/configurations/buildspec-${lambdaName}.yml -i ${cmd.image} -s ${cmd.source} -a ${cmd.artifact}${lambdaName}/ -e ${cmd.env}`, (err, stdout, stderr) => {
		exec(`mv ${cmd.artifact}${lambdaName}/artifacts.zip ${cmd.artifact}${lambdaName}/virus-file-${lambdaName}-lambda.zip`, (err, stdout, stderr) => {
			cb(err);
		});
	});
}

gulp.task('build-scan-lambda', (cb) => buildLambda('scan', cb));
gulp.task('build-report-lambda', (cb) => buildLambda('report', cb));

gulp.task('build', gulp.series(
	'build-scan-lambda',
	'build-report-lambda'
));
